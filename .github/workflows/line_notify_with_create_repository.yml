name: Push Commit Notification

on:
  push:
    branches:
      - main
      - develop

jobs:
  notify_on_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Install jq
        run: sudo apt-get install jq
        
      - name: Get commit diff and prepare payload
        id: prepare_payload
        env:
          COMMIT_URL: ${{ github.event.head_commit.url }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_SHA: ${{ github.event.after }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_DATE: ${{ github.event.head_commit.timestamp }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | head -n 5)
          
          # å·®åˆ†æƒ…å ±ã‚’jqã«æ¸¡ã›ã‚‹ã‚ˆã†ã«æ•´å½¢
          if [ -z "$changed_files" ]; then
            file_list="å¤‰æ›´ãªã—"
          else
            file_list=$(echo "$changed_files" | jq -R -s -c 'split("\n") | map(select(length > 0)) | join("\n")' | sed 's/^"//; s/"$//' | sed 's/\\n/\n/g')
          fi

          # Flex Messageã®JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
          payload=$(jq -n --arg message "$COMMIT_MESSAGE" --arg author "$COMMIT_AUTHOR" --arg url "$COMMIT_URL" --arg sha "$COMMIT_SHA" --arg date "$COMMIT_DATE" --arg branch "$BRANCH_NAME" --arg file_list "$file_list" '{
            "to": "${{ secrets.GROUP_ID }}",
            "messages": [
              {
                "type": "flex",
                "altText": "æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸã€‚",
                "contents": {
                  "type": "bubble",
                  "header": {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                      {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [],
                        "cornerRadius": "5000px",
                        "width": "16px",
                        "height": "16px",
                        "spacing": "none",
                        "margin": "none",
                        "backgroundColor": "#57ab5b",
                        "offsetTop": "2px"
                      },
                      {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                          {
                            "type": "text",
                            "text": $message,
                            "color": "#d0d7e0",
                            "wrap": true,
                            "action": {
                                "type": "uri",
                                "label": "action",
                                "uri": $url
                            },
                            "decoration": "underline"
                          },
                          {
                            "type": "text",
                            "wrap": true,
                            "text": ($sha | cut -c1-7),
                            "color": "#666666"
                          }
                        ]
                      }
                    ],
                    "backgroundColor": "#141c21",
                    "alignItems": "flex-start",
                    "spacing": "md"
                  },
                  "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "box",
                        "layout": "vertical",
                        "margin": "md",
                        "spacing": "none",
                        "contents": [
                          {
                            "type": "text",
                            "text": "ðŸ“… æ—¥æ™‚: " + ($date | fromdateiso8601 | strftime("%Y-%m-%d %H:%M:%S")),
                            "wrap": true,
                            "color": "#666666",
                            "size": "sm"
                          },
                          {
                            "type": "text",
                            "text": "ðŸŒ³ ãƒ–ãƒ©ãƒ³ãƒ: " + $branch,
                            "wrap": true,
                            "color": "#666666",
                            "size": "sm"
                          },
                          {
                            "type": "separator"
                          },
                          {
                            "type": "text",
                            "text": "âœï¸ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:",
                            "weight": "bold",
                            "color": "#666666",
                            "size": "sm",
                            "margin": "md"
                          },
                          {
                            "type": "text",
                            "text": $file_list,
                            "wrap": true,
                            "color": "#666666",
                            "size": "sm"
                          }
                        ]
                      }
                    ]
                  },
                  "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "text",
                        "text": "ðŸ§‘â€ðŸ’» ä½œæˆè€…: " + $author,
                        "size": "xs",
                        "color": "#666666"
                      }
                    ],
                    "alignItems": "flex-end",
                    "backgroundColor": "#F3F3F3"
                  }
                }
              }
            ]
          }')" >> $GITHUB_OUTPUT

      - name: Call API on push
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          curl -v -X POST https://api.line.me/v2/bot/message/push \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -d "${{ steps.prepare_payload.outputs.payload }}"