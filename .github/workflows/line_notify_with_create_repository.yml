name: Push Commit Notification

on:
  push:
    branches:
      - main
      - develop

jobs:
  notify_on_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install jq
      
      - name: Get commit info and prepare payload
        id: prepare_payload
        env:
          GITHUB_EVENT: ${{ toJSON(github.event) }}
        run: |
          # „Ç≥„Éü„ÉÉ„ÉàÊÉÖÂ†±„Åånull„Åß„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if [ "$(echo "$GITHUB_EVENT" | jq '.commits')" == "null" ]; then
            file_list_text="Â§âÊõ¥„Å™„Åó"
            message="Êñ∞„Åó„ÅÑ„Çø„Ç∞„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü"
            author=$(echo "$GITHUB_EVENT" | jq -r '.pusher.name')
            url=$(echo "$GITHUB_EVENT" | jq -r '.repository.html_url')
            sha=$(echo "$GITHUB_EVENT" | jq -r '.after')
            date=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.timestamp')
            branch=$(echo "$GITHUB_EVENT" | jq -r '.ref | sub("refs/heads/"; "")')

          else
            file_list_json=$(echo "$GITHUB_EVENT" | jq '[.commits[] | .added, .modified, .removed] | flatten | unique | join("\n")')
            
            # jq„ÅåÂá∫Âäõ„Åô„Çã‰∫åÈáçÂºïÁî®Á¨¶„ÇíÂâäÈô§
            file_list_text=$(echo "$file_list_json" | sed 's/^"//; s/"$//')
            
            message=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.message')
            author=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.author.name')
            url=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.url')
            sha=$(echo "$GITHUB_EVENT" | jq -r '.after')
            date=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.timestamp')
            branch=$(echo "$GITHUB_EVENT" | jq -r '.ref | sub("refs/heads/"; "")')
          fi

          # Flex Message„ÅÆJSON„Éö„Ç§„É≠„Éº„Éâ„Çí‰ΩúÊàê
          payload=$(jq -n \
            --arg message "$message" \
            --arg author "$author" \
            --arg url "$url" \
            --arg sha "$sha" \
            --arg date "$date" \
            --arg branch "$branch" \
            --arg file_list "$file_list_text" '{
            "to": "${{ secrets.GROUP_ID }}",
            "messages": [
              {
                "type": "flex",
                "altText": "Êñ∞„Åó„ÅÑ„Ç≥„Éü„ÉÉ„Éà„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
                "contents": {
                  "type": "bubble",
                  "header": {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                      {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [],
                        "cornerRadius": "5000px",
                        "width": "16px",
                        "height": "16px",
                        "spacing": "none",
                        "margin": "none",
                        "backgroundColor": "#57ab5b",
                        "offsetTop": "2px"
                      },
                      {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                          {
                            "type": "text",
                            "text": $message,
                            "color": "#d0d7e0",
                            "wrap": true,
                            "action": {
                                "type": "uri",
                                "label": "action",
                                "uri": $url
                            },
                            "decoration": "underline"
                          },
                          {
                            "type": "text",
                            "wrap": true,
                            "text": ($sha | cut -c1-7),
                            "color": "#666666"
                          }
                        ]
                      }
                    ],
                    "backgroundColor": "#141c21",
                    "alignItems": "flex-start",
                    "spacing": "md"
                  },
                  "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "text",
                        "text": ("üå≥ „Éñ„É©„É≥„ÉÅ: " + $branch),
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm"
                      },
                      {
                        "type": "separator"
                      },
                      {
                        "type": "text",
                        "text": "‚úèÔ∏è Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´:",
                        "weight": "bold",
                        "color": "#666666",
                        "size": "sm",
                        "margin": "md"
                      },
                      {
                        "type": "text",
                        "text": $file_list,
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm"
                      }
                    ]
                  },
                  "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "text",
                        "text": ("üßë‚Äçüíª ‰ΩúÊàêËÄÖ: " + $author),
                        "size": "xs",
                        "color": "#666666"
                      }
                    ],
                    "alignItems": "flex-end",
                    "backgroundColor": "#F3F3F3"
                  }
                }
              }
            ]
          }')

          curl -v -X POST https://api.line.me/v2/bot/message/push \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -d "$payload"