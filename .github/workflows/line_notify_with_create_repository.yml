name: Push Commit Notification

on:
  push:
    branches:
      - main
      - develop

jobs:
  notify_on_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install jq
      
      - name: Get commit info and prepare payload
        id: prepare_payload
        env:
          GITHUB_EVENT: ${{ toJSON(github.event) }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ãŒnullã®å ´åˆã¨ãã†ã§ãªã„å ´åˆã§å¤‰æ•°ã‚’è¨­å®š
          if [ "$(echo "$GITHUB_EVENT" | jq '.commits')" == "null" ]; then
            MESSAGE="æ–°ã—ã„ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸ"
            AUTHOR=$(echo "$GITHUB_EVENT" | jq -r '.pusher.name')
            URL=$(echo "$GITHUB_EVENT" | jq -r '.repository.html_url')
            SHA=$(echo "$GITHUB_EVENT" | jq -r '.after')
            BRANCH=$(echo "$GITHUB_EVENT" | jq -r '.ref | sub("refs/heads/"; "")')
            FILE_LIST="å¤‰æ›´ãªã—"
          else
            MESSAGE=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.message')
            AUTHOR=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.author.name')
            URL=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.url')
            SHA=$(echo "$GITHUB_EVENT" | jq -r '.after')
            BRANCH=$(echo "$GITHUB_EVENT" | jq -r '.ref | sub("refs/heads/"; "")')
            FILE_LIST=$(echo "$GITHUB_EVENT" | jq '[.commits[].added, .commits[].modified, .commits[].removed] | flatten | unique | join("\n")' | sed 's/^"#; s/"$#')
          fi

          # jqã‚³ãƒãƒ³ãƒ‰ã§payloadã‚’ç”Ÿæˆã™ã‚‹éƒ¨åˆ†ã¯ãã®ã¾ã¾
          payload=$(jq -n \
            --arg message "$MESSAGE" \
            --arg author "$AUTHOR" \
            --arg url "$URL" \
            --arg sha "$SHA" \
            --arg branch "$BRANCH" \
            --arg file_list "$FILE_LIST" '
            {
              "to": "${{ secrets.GROUP_ID }}",
              "messages": [
                {
                  "type": "flex",
                  "altText": "æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸã€‚",
                  "contents": {
                    "type": "bubble",
                      "header": {
                      "type": "box",
                      "layout": "horizontal",
                      "contents": [
                        {
                          "type": "box", # ğŸ“¤ã‚’å›²ã‚€ãƒœãƒƒã‚¯ã‚¹
                          "layout": "vertical",
                          "contents": [
                            {
                              "type": "text",
                              "text": "ğŸ“¤",
                              "color": "#d0d7e0",
                              "offsetTop": "2px"
                            }
                          ],
                          "flex": 0, # ã“ã®ãƒœãƒƒã‚¯ã‚¹ã¯å†…å®¹ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
                          "margin": "none", # å¤–å´ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ãªãã™
                          "paddingAll": "none", # å†…å´ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãªãã™
                          "width": "20px" # ğŸ“¤ã®çµµæ–‡å­—ã®å¹…ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã¨ã‚ˆã‚Šæ­£ç¢ºã«èª¿æ•´å¯èƒ½
                        },
                        {
                          "type": "box", # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å´ã®ãƒœãƒƒã‚¯ã‚¹
                          "layout": "vertical",
                          "contents": [
                            {
                              "type": "text",
                              "text": $message,
                              "color": "#d0d7e0",
                              "wrap": true,
                              "action": {
                                  "type": "uri",
                                  "label": "action",
                                  "uri": $url
                              },
                              "decoration": "underline"
                            },
                            {
                              "type": "text",
                              "wrap": true,
                              "text": ($sha | .[0:7]),
                              "color": "#666666"
                            }
                          ],
                          "flex": 1, # æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹
                          "margin": "none", # å¤–å´ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ãªãã™
                          "paddingAll": "none" # å†…å´ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãªãã™
                        }
                      ],
                      "backgroundColor": "#141c21",
                      "alignItems": "flex-start",
                      "spacing": "none", # ã“ã“ã‚‚noneã«ã™ã‚‹ã“ã¨ã§ã€2ã¤ã®boxé–“ã®éš™é–“ã‚’ãªãã™
                      "paddingAll": "md" # headerå…¨ä½“ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¯æ®‹ã—ã¦ãŠã
                    },

                    "body": {
                      "type": "box",
                      "layout": "vertical",
                      "contents": [
                        {
                          "type": "text",
                          "text": ("ğŸŒ³ ãƒ–ãƒ©ãƒ³ãƒ: " + $branch),
                          "wrap": true,
                          "color": "#666666",
                          "size": "sm"
                        },
                        {
                          "type": "text",
                          "text": ("âœï¸ å¤‰æ›´å†…å®¹: " + $message),
                          "color": "#666666",
                          "size": "sm",
                          "margin": "sm"
                        }
                      ]
                    },
                    "footer": {
                      "type": "box",
                      "layout": "vertical",
                      "contents": [
                        {
                          "type": "text",
                          "text": ("ğŸ§‘â€ğŸ’» å¤‰æ›´è€…: " + $author),
                          "size": "xs",
                          "color": "#666666"
                        }
                      ],
                      "alignItems": "flex-end",
                      "backgroundColor": "#F3F3F3"
                    }
                  }
                }
              ]
            }'
          )

          # curlã‚³ãƒãƒ³ãƒ‰ã‚’ç‹¬ç«‹ã•ã›ã‚‹
          curl -v -X POST https:#api.line.me/v2/bot/message/push \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer ${{ secrets.ACCESS_TOKEN }}" \
          -d "$payload"
          