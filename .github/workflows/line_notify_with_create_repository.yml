name: Push Commit Notification

on:
  push:
    branches:
      - main
      - develop

jobs:
  notify_on_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install jq
        
      - name: Call API on push
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_SHA: ${{ github.event.after }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # „Ç≥„Éü„ÉÉ„ÉàSHA„ÇíÊúÄÂàù„ÅÆ7ÊñáÂ≠ó„Å´Áü≠Á∏Æ
          short_sha=$(echo "$COMMIT_SHA" | cut -c1-7)
          
          commit_author="Committed by: $COMMIT_AUTHOR"
          
          # GitHub„É™„Éù„Ç∏„Éà„É™„ÅÆURL„Çí‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          commit_url="https://github.com/yumachin2003/shinshu-fesnav/commit/$COMMIT_SHA"

          payload=$(jq -n --arg message "$COMMIT_MESSAGE" --arg author "$commit_author" --arg url "$commit_url" --arg sha "$short_sha" '{
            "to": "${{ secrets.GROUP_ID }}",
            "messages": [
              {
                "type":"flex",
                "altText":"Êñ∞„Åó„ÅÑ„Ç≥„Éü„ÉÉ„Éà„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
                "contents": {
                  "type": "bubble",
                  "header": {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                      {
                        "type": "text",
                        "text": "üì§",
                        "size": "sm",
                        "flex": 0, # „Ç¢„Ç§„Ç≥„É≥„ÅåÂπÖ„ÇíÂèñ„Çä„Åô„Åé„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                        "offsetTop": "2px"
                      },
                      {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                          {
                            "type": "text",
                            "text": $title,
                            "color": "#d0d7e0",
                            "action": {
                              "type": "uri",
                              "label": "action",
                              "uri": $url
                            },
                            "wrap": true,
                            "decoration": "underline"
                          },
                          {
                            "type": "text",
                            "wrap": true,
                            "text": $number,
                            "color": "#666666"
                          }
                        ]
                      }
                    ],
                    "backgroundColor": "#141c21",
                    "alignItems": "flex-start",
                    "spacing": "md"
                  },
                  "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "box",
                        "layout": "vertical",
                        "margin": "md",
                        "spacing": "none",
                        "contents": [
                          {
                            "type": "text",
                            "text": $body,
                            "wrap": true,
                            "color": "#666666",
                            "size": "sm"
                          }
                        ]
                      }
                    ]
                  },
                  "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "text",
                        "text": $author,
                        "size": "xs",
                        "color": "#666666"
                      }
                    ],
                    "alignItems": "flex-end",
                    "backgroundColor": "#F3F3F3"
                  }
                }
              }
            ]
          }')

          curl -v -X POST https://api.line.me/v2/bot/message/push \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -d "$payload"
