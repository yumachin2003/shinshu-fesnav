name: Push Commit Notification

on:
  push:
    branches:
      - main
      - develop

jobs:
  notify_on_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install jq
      
      - name: Get commit info and prepare payload
        id: prepare_payload
        env:
          GITHUB_EVENT: ${{ toJSON(github.event) }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # „Ç≥„Éü„ÉÉ„ÉàÊÉÖÂ†±„Åånull„ÅÆÂ†¥Âêà„Å®„Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥Âêà„ÅßÂ§âÊï∞„ÇíË®≠ÂÆö
          if [ "$(echo "$GITHUB_EVENT" | jq '.commits')" == "null" ]; then
            MESSAGE="Êñ∞„Åó„ÅÑ„Çø„Ç∞„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü"
            AUTHOR=$(echo "$GITHUB_EVENT" | jq -r '.pusher.name')
            URL=$(echo "$GITHUB_EVENT" | jq -r '.repository.html_url')
            SHA=$(echo "$GITHUB_EVENT" | jq -r '.after')
            BRANCH=$(echo "$GITHUB_EVENT" | jq -r '.ref | sub("refs/heads/"; "")')
            FILE_LIST="Â§âÊõ¥„Å™„Åó"
          else
            MESSAGE=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.message')
            AUTHOR=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.author.name')
            URL=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.url')
            SHA=$(echo "$GITHUB_EVENT" | jq -r '.after')
            BRANCH=$(echo "$GITHUB_EVENT" | jq -r '.ref | sub("refs/heads/"; "")')
            FILE_LIST=$(echo "$GITHUB_EVENT" | jq '[.commits[].added, .commits[].modified, .commits[].removed] | flatten | unique | join("\n")' | sed 's/^"//; s/"$//')
          fi

          # jq„Ç≥„Éû„É≥„Éâ„Åßpayload„ÇíÁîüÊàê„Åô„ÇãÈÉ®ÂàÜ„ÅØ„Åù„ÅÆ„Åæ„Åæ
          payload=$(jq -n \
            --arg message "$MESSAGE" \
            --arg author "$AUTHOR" \
            --arg url "$URL" \
            --arg sha "$SHA" \
            --arg branch "$BRANCH" \
            --arg file_list "$FILE_LIST" '
            {
              "to": "${{ secrets.GROUP_ID }}",
              "messages": [
                {
                  "type": "flex",
                  "altText": "Êñ∞„Åó„ÅÑ„Ç≥„Éü„ÉÉ„Éà„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
                  "contents": {
                    "type": "bubble",
                    "header": {
                      "type": "box",
                      "layout": "horizontal",
                      "contents": [
                        {
                          "type": "box",
                          "layout": "vertical",
                          "contents": [],
                          "cornerRadius": "5000px",
                          "width": "16px",
                          "height": "16px",
                          "spacing": "none",
                          "margin": "none",
                          "backgroundColor": "#57ab5b",
                          "offsetTop": "2px"
                        },
                        {
                          "type": "box",
                          "layout": "vertical",
                          "contents": [
                            {
                              "type": "text",
                              "text": $message,
                              "color": "#d0d7e0",
                              "wrap": true,
                              "action": {
                                  "type": "uri",
                                  "label": "action",
                                  "uri": $url
                              },
                              "decoration": "underline"
                            },
                            {
                              "type": "text",
                              "wrap": true,
                              "text": ($sha | .[0:7]),
                              "color": "#666666"
                            }
                          ]
                        }
                      ],
                      "backgroundColor": "#141c21",
                      "alignItems": "flex-start",
                      "spacing": "md"
                    },
                    "body": {
                      "type": "box",
                      "layout": "vertical",
                      "contents": [
                        {
                          "type": "text",
                          "text": ("üå≥ „Éñ„É©„É≥„ÉÅ: " + $branch),
                          "wrap": true,
                          "color": "#666666",
                          "size": "sm"
                        },
                        {
                          "type": "separator"
                        },
                        {
                          "type": "text",
                          "text": "‚úèÔ∏è Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´:",
                          "weight": "bold",
                          "color": "#666666",
                          "size": "sm",
                          "margin": "md"
                        },
                        {
                          "type": "text",
                          "text": $file_list,
                          "wrap": true,
                          "color": "#666666",
                          "size": "sm"
                        }
                      ]
                    },
                    "footer": {
                      "type": "box",
                      "layout": "vertical",
                      "contents": [
                        {
                          "type": "text",
                          "text": ("üßë‚Äçüíª ‰ΩúÊàêËÄÖ: " + $author),
                          "size": "xs",
                          "color": "#666666"
                        }
                      ],
                      "alignItems": "flex-end",
                      "backgroundColor": "#F3F3F3"
                    }
                  }
                }
              ]
            }'
          )

          # curl„Ç≥„Éû„É≥„Éâ„ÇíÁã¨Á´ã„Åï„Åõ„Çã
          curl -v -X POST https://api.line.me/v2/bot/message/push \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer ${{ secrets.ACCESS_TOKEN }}" \
          -d "$payload"
          