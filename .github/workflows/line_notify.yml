name: Push Commit Notification

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'

jobs:
  notify_on_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install jq
      
      - name: Get commit info and prepare payload
        id: prepare_payload
        env:
          GITHUB_EVENT: ${{ toJSON(github.event) }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # jq„ÅÆ`//`ÊºîÁÆóÂ≠ê„Çí‰Ωø„Å£„Å¶„ÄÅÂ§âÊï∞„ÇíÁõ¥Êé•ÂÆöÁæ©
          MESSAGE=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.message // "Êñ∞„Åó„ÅÑ„Çø„Ç∞„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü"')
          AUTHOR=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.author.name // .pusher.name')
          URL=$(echo "$GITHUB_EVENT" | jq -r '.head_commit.url // .repository.html_url')
          SHA=$(echo "$GITHUB_EVENT" | jq -r '.after')
          BRANCH=$(echo "$GITHUB_EVENT" | jq -r '.ref | sub("refs/heads/"; "")')

          # jq„Ç≥„Éû„É≥„Éâ„Åßpayload„ÇíÁîüÊàê
          payload=$(jq -n \
            --arg message "$MESSAGE" \
            --arg author "$AUTHOR" \
            --arg url "$URL" \
            --arg sha "$SHA" \
            --arg branch "$BRANCH" '
            {
              "to": "${{ secrets.GROUP_ID }}",
              "messages": [
                {
                  "type": "flex",
                  "altText": ($author + "„Å´„Çà„Å£„Å¶Êñ∞„Åó„ÅÑ„Ç≥„Éü„ÉÉ„Éà„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü„ÄÇ"),
                  "contents": {
                    "type": "bubble",
                      "header": {
                      "type": "box",
                      "layout": "horizontal",
                      "contents": [
                        {
                          "type": "box",
                          "layout": "vertical",
                          "contents": [
                            {
                              "type": "text",
                              "text": "üì§",
                              "color": "#d0d7e0",
                              "offsetTop": "2px"
                            }
                          ],
                          "flex": 0,
                          "width": "20px"
                        },
                        {
                          "type": "box",
                          "layout": "vertical",
                          "contents": [
                            {
                              "type": "text",
                              "text": "Êñ∞„Åó„ÅÑ„Ç≥„Éü„ÉÉ„Éà„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
                              "color": "#d0d7e0",
                              "wrap": true,
                              "weight": "bold",
                            },
                            {
                              "type": "text",
                              "wrap": true,
                              "text": ($sha | .[0:7]),
                              "color": "#666666",
                              "margin": "sm"
                            }
                          ]
                        }
                      ],
                      "backgroundColor": "#141c21",
                      "alignItems": "flex-start",
                      "spacing": "md"
                    },

                    "body": {
                      "type": "box",
                      "layout": "vertical",
                      "contents": [
                        {
                          "type": "box",
                          "layout": "horizontal",
                          "contents": [
                            {
                              "type": "text",
                              "text": "üå≥ „Éñ„É©„É≥„ÉÅ: ",
                              "wrap": true,
                              "color": "#666666",
                              "size": "sm",
                              "flex": 0,
                              "weight": "bold"
                            },
                            {
                              "type": "text",
                              "text": $branch,
                              "wrap": true,
                              "color": "#666666",
                              "size": "sm",
                              "flex": 1 
                            }
                          ]
                        },
                        {
                          "type": "box",
                          "layout": "horizontal",
                          "contents": [
                            {
                              "type": "text",
                              "wrap": true,
                              "text": "‚úèÔ∏è Â§âÊõ¥ÂÜÖÂÆπ: ",
                              "color": "#666666",
                              "size": "sm",
                              "margin": "none",
                              "flex": 0,
                              "weight": "bold"
                            },
                            {
                              "type": "text",
                              "wrap": true,
                              "text": $message,
                              "color": "#666666",
                              "size": "sm",
                              "margin": "none",
                              "flex": 1
                            }
                          ],
                          "action": {
                            "type": "uri",
                            "label": "Â§âÊõ¥ÂÜÖÂÆπ„Çí„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„Åè",
                            "uri": $url
                          }
                        }
                      ],
                      "margin": "md"
                    },

                    "footer": {
                      "type": "box",
                      "layout": "vertical",
                      "contents": [
                        {
                          "type": "text",
                          "text": ("üßë‚Äçüíª Â§âÊõ¥ËÄÖ: " + $author),
                          "size": "xs",
                          "color": "#666666"
                        }
                      ],
                      "alignItems": "flex-end",
                      "backgroundColor": "#F3F3F3",
                      "margin": "md"
                    }
                  }
                }
              ]
            }'
          )

          # curl„Ç≥„Éû„É≥„Éâ„ÇíÁã¨Á´ã„Åï„Åõ„Çã
          curl -v -X POST https://api.line.me/v2/bot/message/push \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer ${{ secrets.ACCESS_TOKEN }}" \
          -d "$payload"